<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opentrons Releases</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple transition for the dropdown arrow */
        .rotate-180 {
            transform: rotate(180deg);
        }
        .transition-transform {
            transition: transform 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto px-4 py-8 md:py-12">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Opentrons Releases ðŸš€</h1>
            <p class="text-lg text-gray-600 mt-2">A live list of the latest software releases (starting with 'v').</p>
        </header>

        <main>

            <!-- Search Bar and Alpha Toggle -->
            <div class="max-w-2xl mx-auto mb-6 flex flex-col gap-2">
                <input type="text" id="search-bar" placeholder="Search for a release version..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                <label class="flex items-center gap-3 px-3 py-2 bg-gray-100 rounded-lg shadow-sm hover:bg-blue-50 transition cursor-pointer font-medium text-gray-700 w-fit">
                    <input type="checkbox" id="show-alpha-checkbox" class="form-checkbox h-5 w-5 text-blue-600 focus:ring-2 focus:ring-blue-500 border-gray-300 rounded transition">
                    <span class="select-none">Show <span class="text-blue-600 font-semibold">alpha</span> releases</span>
                </label>
            </div>

            <div id="releases-container" class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
                <div id="loading-state" class="text-center text-gray-500">
                    <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2">Fetching all releases...</p>
                </div>
                <ul id="releases-list" class="space-y-1">
                    <!-- Release items will be dynamically inserted here -->
                </ul>
            </div>
        </main>
    </div>

    <script>
        // Main function to fetch and display GitHub releases for the Opentrons repository.
        async function fetchAndDisplayReleases() {
            // Get references to the DOM elements we'll be manipulating.

            const releasesList = document.getElementById('releases-list');
            const loadingState = document.getElementById('loading-state');
            const searchBar = document.getElementById('search-bar');
            const showAlphaCheckbox = document.getElementById('show-alpha-checkbox');


            try {
                // Initialize an array to hold all releases fetched from the API.
                let allReleases = [];
                let page = 1;
                const perPage = 100; // Fetch 100 releases per page for efficiency.

                // Loop to fetch all pages of releases from the GitHub API.
                while (true) {
                    const apiUrl = `https://api.github.com/repos/Opentrons/opentrons/releases?page=${page}&per_page=${perPage}`;
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const releasesOnPage = await response.json();
                    // If a page has no releases, we've reached the end.
                    if (releasesOnPage.length === 0) break;

                    allReleases = allReleases.concat(releasesOnPage);
                    page++;
                }

                // Hide the loading spinner once all data is fetched.
                loadingState.style.display = 'none';

                // Function to filter and render releases based on checkbox and search
                function renderReleases() {
                    releasesList.innerHTML = '';
                    const showAlpha = showAlphaCheckbox.checked;
                    const searchTerm = searchBar.value.toLowerCase();
                    const filteredReleases = allReleases.filter(release => {
                        const tag = release.tag_name;
                        if (!tag.startsWith('v')) return false;
                        if (!showAlpha && tag.includes('alpha')) return false;
                        if (tag.includes('beta')) return false;
                        if (searchTerm && !tag.toLowerCase().includes(searchTerm)) return false;
                        return true;
                    });

                    filteredReleases.forEach(release => {
                        const listItem = document.createElement('li');
                        listItem.className = 'release-item border-b border-gray-200 last:border-b-0 py-2';

                        // --- Create the main header for the release item ---
                        const releaseHeader = document.createElement('div');
                        releaseHeader.className = 'flex justify-between items-center cursor-pointer p-2 rounded-md hover:bg-gray-100';

                        const releaseInfoDiv = document.createElement('div');

                        // Create the link to the GitHub release page.
                        const link = document.createElement('a');
                        link.href = release.html_url;
                        link.textContent = release.tag_name;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.className = 'font-semibold text-xl text-blue-600 hover:underline release-tag';

                        // Format and display the publication date.
                        const date = new Date(release.published_at);
                        const dateSpan = document.createElement('span');
                        dateSpan.textContent = ` - Published on ${date.toLocaleDateString()}`;
                        dateSpan.className = 'text-sm text-gray-500 ml-2';

                        releaseInfoDiv.appendChild(link);
                        releaseInfoDiv.appendChild(dateSpan);

                        // Create the dropdown arrow icon.
                        const arrowIcon = document.createElement('div');
                        arrowIcon.innerHTML = `<svg class="w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>`;

                        releaseHeader.appendChild(releaseInfoDiv);
                        releaseHeader.appendChild(arrowIcon);
                        listItem.appendChild(releaseHeader);

                        // --- Create the container for asset download links (initially hidden) ---
                        const assetsContainer = document.createElement('div');
                        assetsContainer.className = 'assets-container hidden mt-2 pl-6 border-l-2 border-gray-200 ml-2';

                        // Filter for relevant assets: app installers and robot system files.
                        const relevantAssets = release.assets.filter(asset =>
                            asset.name.endsWith('.dmg') ||         // Mac App
                            asset.name.endsWith('.exe') ||        // Windows App
                            asset.name.endsWith('.AppImage') ||   // Linux App
                            (asset.name.startsWith('ot2-system') && asset.name.endsWith('.zip')) ||
                            (asset.name.startsWith('ot3-system') && asset.name.endsWith('.zip'))
                        ).sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically for consistency.

                        // If relevant assets are found, create links for them.
                        if (relevantAssets.length > 0) {
                            relevantAssets.forEach(asset => {
                                const assetLink = document.createElement('a');
                                assetLink.href = asset.browser_download_url;
                                assetLink.className = 'flex items-center text-sm text-green-700 hover:text-green-900 hover:underline py-1';
                                assetLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg><span>${asset.name}</span>`;
                                assetsContainer.appendChild(assetLink);
                            });
                            listItem.appendChild(assetsContainer);
                        } else {
                            // If no assets are found, hide the dropdown arrow and remove the pointer cursor.
                            arrowIcon.classList.add('hidden');
                            releaseHeader.classList.remove('cursor-pointer');
                        }

                        // Add click listener to the header to toggle the assets dropdown.
                        releaseHeader.addEventListener('click', () => {
                            if (relevantAssets.length > 0) {
                                assetsContainer.classList.toggle('hidden');
                                arrowIcon.querySelector('svg').classList.toggle('rotate-180');
                            }
                        });

                        releasesList.appendChild(listItem);
                    });
                }

                // Initial render
                renderReleases();

                // Add event listeners for live filtering
                searchBar.addEventListener('input', renderReleases);
                showAlphaCheckbox.addEventListener('change', renderReleases);

            } catch (error) {
                // Display an error message if the fetch fails.
                loadingState.innerHTML = `<p class="text-red-500 font-semibold">Failed to load releases.</p><p class="text-sm text-gray-500">${error.message}</p>`;
                console.error('Error fetching releases:', error);
            }
        }

        // Run the main function after the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', fetchAndDisplayReleases);
    </script>

</body>
</html>
